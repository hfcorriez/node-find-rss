// Generated by CoffeeScript 1.6.3
module.exports = function(req, callback) {
  var async, candidates, favicon, htmlparser, parser, request, sitename, sitenameFlag, url;
  htmlparser = require("htmlparser2");
  async = require('async');
  url = require('url');
  request = require('request');
  candidates = [];
  sitename = '';
  sitenameFlag = false;
  favicon = '';
  parser = new htmlparser.Parser({
    onopentag: function(name, attr) {
      if (name === "link" && attr.type === "application/rss+xml" || attr.type === "application/atom+xml") {
        candidates.push(attr);
      }
      if (name === 'link' && (attr.rel === 'icon' || attr.rel === 'shortcut icon' || attr.type === 'image/x-icon')) {
        favicon = attr.href;
      }
      if (name === "title") {
        return sitenameFlag = true;
      }
    },
    ontext: function(text) {
      if (sitenameFlag) {
        return sitename = text;
      }
    },
    onclosetag: function(name) {
      if (name === "title") {
        return sitenameFlag = false;
      }
    }
  });
  return request(req, function(err, res, body) {
    var obj;
    if (err != null) {
      callback(err, null);
      return;
    }
    obj = url.parse(req);
    parser.write(body);
    parser.end();
    return async.forEach(candidates, function(cand, cb) {
      var guess;
      cand.sitename = sitename;
      if (cand.href.match(/[http|https]:\/\//)) {
        cand.url = cand.href;
      } else {
        cand.url = "" + obj.protocol + "//" + obj.host + cand.href;
      }
      if (favicon != null) {
        cand.favicon = favicon;
        return cb();
      } else {
        guess = "" + obj.protocol + "//" + obj.host + "/favicon.ico";
        return request(guess, function(err, res, body) {
          if (res.statusCode === 200) {
            cand.favicon === guess;
          }
          return cb();
        });
      }
    }, function() {
      if (candidates.length === 0) {
        return callback('no such rss feeds.', null);
      } else {
        return callback(null, candidates);
      }
    });
  });
};
